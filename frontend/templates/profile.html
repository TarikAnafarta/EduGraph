<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - EduGraph</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 {
            font-size: 1.5rem;
            cursor: pointer;
        }

        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 2rem;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            font-weight: bold;
            position: relative;
            cursor: default; /* avatar tÄ±klanamaz */
            overflow: hidden; /* resim daire iÃ§inde kalsÄ±n */
            transition: all 0.3s ease;
        }
        /* Avatar iÃ§indeki img dÃ¼zgÃ¼n boyut ve kÄ±rpma ile gÃ¶rÃ¼nmeli */
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border-radius: 50%;
            display: block;
        }

        /* Eski hover overlay'i tamamen gizle */
        .avatar-overlay { display: none !important; }

        /* Avatar ve kamera butonu iÃ§in sarmalayÄ±cÄ± */
        .avatar-wrapper {
            position: relative;
            display: inline-block;
        }

        /* Kamera butonu avatarÄ±n DIÅžINDA sol-alt */
        .avatar-camera-btn {
            position: absolute;
            left: -10px; /* tamamen dÄ±ÅŸarÄ±da olsun */
            bottom: -10px; /* tamamen dÄ±ÅŸarÄ±da olsun */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #ffffff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            display: grid;
            place-items: center;
            cursor: pointer;
            padding: 0;
            z-index: 2; /* avatar Ã¼stÃ¼nde */
        }
        .avatar-camera-btn:hover { background: #f3f4f6; }
        .avatar-camera-btn svg { width: 18px; height: 18px; color: #4b5563; }

        .profile-info h2 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .profile-info p {
            color: #666;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info-item label {
            display: block;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .info-item .value {
            color: #333;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .edit-mode input,
        .edit-mode select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1rem;
            color: #333;
            background: white;
        }

        .edit-mode input:focus,
        .edit-mode select:focus {
            outline: none;
            border-color: #764ba2;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .read-only {
            opacity: 0.8;
        }

        .back-btn {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* --- Profile picture cropper modal (compact) --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; align-items: center; justify-content: center; 
            z-index: 1000; padding: 1rem; 
        }
        .modal-overlay.open { display: flex; }
        .modal {
            width: 100%; max-width: 620px; background: #fff; border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;
        }
        .modal-header { padding: 1rem 1.25rem; font-weight: 700; font-size: 1.1rem; color:#333; }
        .modal-body { padding: 0 1.25rem 1rem; }
        .crop-frame {
            position: relative; margin: 0 auto; background: #2b2f36; border-radius: 12px; 
            width: min(92vw, 560px); height: var(--h, 260px); /* height set dynamically to circle diameter */
            overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
        }
        #crop-image { 
            position: absolute; top: 50%; left: 50%; will-change: transform; 
            user-select: none; -webkit-user-drag: none; pointer-events: auto;
        }
        .circle-mask { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: var(--d, 240px); height: var(--d, 240px); border-radius: 50%; 
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.55); border: 2px dashed #7cd992; 
            pointer-events: none;
        }
        .controls { display: grid; gap: .75rem; margin-top: 1rem; }
        .range-row { display:flex; align-items:center; gap: .75rem; }
        .range-row label { width: 90px; color:#555; font-size: .9rem; }
        .range-row input[type="range"] { flex:1; }
        .modal-actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem; padding: 0 0 .75rem; }
        .btn-light { background:#f1f3f5; color:#333; }
        .btn-green { background:#28a745; color:#fff; }
        .btn-light, .btn-green {
            border: none; padding: .6rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; 
        }
        .btn-light:hover { background:#e9ecef; }
        .btn-green:hover { background:#218838; }
        .btn-upload { display: inline-flex; align-items:center; gap:.5rem; background:#e8f7ec; color:#257942; border:1px solid #c6efce; }
        .btn-upload:hover { background:#dcf3e3; }

        @media (max-width: 520px){
            .circle-mask { width: var(--d, 200px); height: var(--d, 200px); }
            .modal { max-width: 96vw; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1 onclick="window.location.href='/dashboard/'">ðŸ“š EduGraph</h1>
        <div class="user-info">
            <a href="/dashboard/" class="back-btn">Geri DÃ¶n</a>
        </div>
    </div>

    <div class="container">
        <div class="alert" id="alert-message"></div>
        
        <div class="profile-card">
            <div class="profile-header">
                <div class="avatar-wrapper">
                    <div class="profile-avatar" id="avatar"></div>
                    <button class="avatar-camera-btn" id="avatar-camera-btn" type="button" title="Profil fotoÄŸrafÄ±nÄ± deÄŸiÅŸtir" aria-label="Profil fotoÄŸrafÄ±nÄ± deÄŸiÅŸtir">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" aria-hidden="true">
                            <path d="M512 144v288c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V144c0-26.5 21.5-48 48-48h88l12.3-32.9c7-18.7 24.9-31.1 44.9-31.1h125.5c20 0 37.9 12.4 44.9 31.1L376 96h88c26.5 0 48 21.5 48 48zM376 288c0-66.2-53.8-120-120-120s-120 53.8-120 120 53.8 120 120 120 120-53.8 120-120zm-32 0c0 48.5-39.5 88-88 88s-88-39.5-88-88 39.5-88 88-88 88 39.5 88 88z"></path>
                        </svg>
                    </button>
                </div>
                <input type="file" id="profile-picture-input" accept="image/*" onchange="uploadProfilePicture(event)" style="display:none;">
                <div class="profile-info">
                    <h2 id="user-name">YÃ¼kleniyor...</h2>
                    <p id="user-email">YÃ¼kleniyor...</p>
                </div>
            </div>

            <div class="info-grid" id="info-grid">
                <div class="info-item">
                    <label>Ä°sim</label>
                    <div class="value" id="user-name-field">-</div>
                </div>
                <div class="info-item">
                    <label>SÄ±nÄ±f</label>
                    <div class="value" id="user-grade">-</div>
                </div>
                <div class="info-item">
                    <label>Alan</label>
                    <div class="value" id="user-track">-</div>
                </div>
                <div class="info-item">
                    <label>Ãœyelik Tarihi</label>
                    <div class="value read-only" id="user-joined">-</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="edit-btn" onclick="toggleEditMode()">Profili DÃ¼zenle</button>
                <button class="btn btn-success" id="save-btn" onclick="saveProfile()" style="display: none;">DeÄŸiÅŸiklikleri Kaydet</button>
                <button class="btn btn-secondary" id="cancel-btn" onclick="cancelEdit()" style="display: none;">Ä°ptal</button>
            </div>
        </div>
    </div>

    <!-- Compact Cropper Modal -->
    <div id="cropper-overlay" class="modal-overlay" aria-modal="true" role="dialog">
        <div class="modal">
            <div class="modal-header">Profil FotoÄŸrafÄ±nÄ± GÃ¼ncelle</div>
            <div class="modal-body">
                <div id="crop-frame" class="crop-frame">
                    <img id="crop-image" alt="crop" />
                    <div id="circle-mask" class="circle-mask"></div>
                </div>
                <div class="controls">
                    <div class="range-row">
                        <label for="zoom-range">YakÄ±nlaÅŸtÄ±r</label>
                        <input id="zoom-range" type="range" min="100" max="300" value="100" />
                        <span id="zoom-label" style="width:48px; text-align:right; color:#666; font-size:.9rem;">100%</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="reselect-btn" type="button" class="btn-light btn-upload">ðŸ“¤ Dosya SeÃ§</button>
                    <button id="cancel-crop-btn" type="button" class="btn-light">Ä°ptal</button>
                    <button id="save-crop-btn" type="button" class="btn-green">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userToken = '';
        let isEditMode = false;
        let originalUserData = {};

        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return '';
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert-message');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        async function loadUserInfo() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            userToken = token;

            try {
                const response = await fetch('/api/users/me/', {
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    originalUserData = { ...user };
                    displayUserInfo(user);
                    ensureCameraButton(); // keep the camera button after rendering avatar
                } else {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Failed to load user information:', error);
                showAlert('KullanÄ±cÄ± bilgileri yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin.', 'error');
            }
        }

        function displayUserInfo(user) {
            // Update profile info
            document.getElementById('user-name').textContent = user.name || 'KullanÄ±cÄ±';
            document.getElementById('user-email').textContent = user.email;
            
            // Display name in editable field
            document.getElementById('user-name-field').textContent = user.name || '-';
            
            // Display grade
            if (user.grade) {
                document.getElementById('user-grade').textContent = `${user.grade}. SÄ±nÄ±f`;
            } else {
                document.getElementById('user-grade').textContent = '-';
            }
            
            // Display track
            if (user.track) {
                const trackLabels = {
                    'lgs': 'LGS',
                    'sayisal': 'SayÄ±sal',
                    'sozel': 'SÃ¶zel'
                };
                document.getElementById('user-track').textContent = trackLabels[user.track] || user.track;
            } else {
                document.getElementById('user-track').textContent = '-';
            }
            
            // Format date
            if (user.date_joined) {
                const date = new Date(user.date_joined);
                document.getElementById('user-joined').textContent = date.toLocaleDateString('tr-TR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // Update avatar
            const avatarDiv = document.getElementById('avatar');
            if (user.profile_picture) {
                avatarDiv.innerHTML = `<img src="${user.profile_picture}" alt="Profile Picture">`;
            } else {
                const firstLetter = (user.name || user.email || 'K')[0].toUpperCase();
                avatarDiv.innerHTML = `${firstLetter}`;
            }
        }

        function toggleEditMode() {
            isEditMode = true;
            const user = originalUserData;

            // Replace name with input
            const nameField = document.getElementById('user-name-field');
            nameField.innerHTML = `<input type="text" id="edit-name" value="${user.name || ''}" />`;

            // Replace grade with select
            const gradeField = document.getElementById('user-grade');
            const gradeOptions = [];
            for (let i = 5; i <= 12; i++) {
                gradeOptions.push(`<option value="${i}" ${user.grade === i ? 'selected' : ''}>${i}. SÄ±nÄ±f</option>`);
            }
            gradeField.innerHTML = `<select id="edit-grade">${gradeOptions.join('')}</select>`;

            // Replace track with select (will be updated based on grade)
            updateTrackOptions(user.grade, user.track);

            // Add change listener to grade select
            document.getElementById('edit-grade').addEventListener('change', function() {
                const selectedGrade = parseInt(this.value);
                const currentTrack = document.getElementById('edit-track').value;
                updateTrackOptions(selectedGrade, currentTrack);
            });

            // Add edit-mode class to grid
            document.getElementById('info-grid').classList.add('edit-mode');

            // Toggle buttons
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('save-btn').style.display = 'inline-block';
            document.getElementById('cancel-btn').style.display = 'inline-block';
        }

        function updateTrackOptions(grade, selectedTrack) {
            const trackField = document.getElementById('user-track');
            let trackOptions = '';

            if (grade <= 8) {
                trackOptions = `<option value="lgs" selected>LGS</option>`;
            } else {
                trackOptions = `
                    <option value="sayisal" ${selectedTrack === 'sayisal' ? 'selected' : ''}>SayÄ±sal</option>
                    <option value="sozel" ${selectedTrack === 'sozel' ? 'selected' : ''}>SÃ¶zel</option>
                `;
            }

            trackField.innerHTML = `<select id="edit-track">${trackOptions}</select>`;
        }

        function cancelEdit() {
            isEditMode = false;
            displayUserInfo(originalUserData);
            document.getElementById('info-grid').classList.remove('edit-mode');

            // Toggle buttons
            document.getElementById('edit-btn').style.display = 'inline-block';
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        async function saveProfile() {
            const saveBtn = document.getElementById('save-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            // Disable buttons during save
            saveBtn.disabled = true;
            cancelBtn.disabled = true;
            saveBtn.textContent = 'Kaydediliyor...';

            try {
                const name = document.getElementById('edit-name').value.trim();
                const grade = parseInt(document.getElementById('edit-grade').value);
                const track = document.getElementById('edit-track').value;

                // Validate
                if (!name) {
                    showAlert('Ä°sim boÅŸ bÄ±rakÄ±lamaz', 'error');
                    return;
                }

                // Prepare update data
                const updateData = {
                    name: name,
                    grade: grade,
                    track: track
                };

                const response = await fetch('/api/users/me/', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Token ${userToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    originalUserData = { ...updatedUser };
                    
                    // Exit edit mode and display updated info
                    isEditMode = false;
                    displayUserInfo(updatedUser);
                    document.getElementById('info-grid').classList.remove('edit-mode');

                    // Update header name
                    document.getElementById('user-name').textContent = updatedUser.name;
                    
                    // Update avatar
                    const avatarDiv = document.getElementById('avatar');
                    if (updatedUser.profile_picture) {
                        avatarDiv.innerHTML = `
                            <img src="${updatedUser.profile_picture}" alt="Profile Picture">
                        `;
                    } else {
                        const firstLetter = (updatedUser.name || updatedUser.email || 'K')[0].toUpperCase();
                        avatarDiv.innerHTML = `
                            ${firstLetter}
                        `;
                    }

                    showAlert('Profil baÅŸarÄ±yla gÃ¼ncellendi! âœ“', 'success');

                    // Toggle buttons
                    document.getElementById('edit-btn').style.display = 'inline-block';
                    document.getElementById('save-btn').style.display = 'none';
                    document.getElementById('cancel-btn').style.display = 'none';
                } else {
                    const errorData = await response.json();
                    let errorMessage = 'Profil gÃ¼ncellenirken bir hata oluÅŸtu';
                    
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.track) {
                        errorMessage = errorData.track[0] || errorData.track;
                    } else if (errorData.grade) {
                        errorMessage = errorData.grade[0] || errorData.grade;
                    }
                    
                    showAlert(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Failed to update profile:', error);
                showAlert('Profil gÃ¼ncellenirken bir hata oluÅŸtu', 'error');
            } finally {
                saveBtn.disabled = false;
                cancelBtn.disabled = false;
                saveBtn.textContent = 'DeÄŸiÅŸiklikleri Kaydet';
            }
        }

        // --- Simple horizontal cropper state ---
        let cropState = {
            url: null,
            imgEl: null,
            frameEl: null,
            maskEl: null,
            d: 240, // circle diameter (px)
            naturalW: 0,
            naturalH: 0,
            scale: 1,
            minScale: 1,
            offsetX: 0, // visible px shift after scaling
            offsetY: 0, // NEW: vertical shift
            dragging: false,
            dragStartX: 0,
            dragStartY: 0, // NEW
            startOffsetX: 0,
            startOffsetY: 0, // NEW
        };

        function openCropModal(file){
            const overlay = document.getElementById('cropper-overlay');
            cropState.frameEl = document.getElementById('crop-frame');
            cropState.imgEl = document.getElementById('crop-image');
            cropState.maskEl = document.getElementById('circle-mask');

            // Compute circle diameter from frame width and make frame height equal to circle size
            const rect = cropState.frameEl.getBoundingClientRect();
            const frameW = rect.width || cropState.frameEl.clientWidth || 560;
            cropState.d = Math.floor(frameW - 80); // some horizontal breathing space
            cropState.d = Math.max(160, Math.min(320, cropState.d)); // clamp compact size
            cropState.frameEl.style.height = cropState.d + 'px'; // shrink dark background to circle height
            cropState.maskEl.style.setProperty('--d', cropState.d + 'px');

            // Clean previous url
            if(cropState.url){ URL.revokeObjectURL(cropState.url); }
            cropState.url = URL.createObjectURL(file);

            // Load image
            cropState.imgEl.onload = () => {
                cropState.naturalW = cropState.imgEl.naturalWidth || cropState.imgEl.width;
                cropState.naturalH = cropState.imgEl.naturalHeight || cropState.imgEl.height;

                const needW = cropState.d / cropState.naturalW;
                const needH = cropState.d / cropState.naturalH;
                cropState.minScale = Math.max(needW, needH);
                cropState.scale = cropState.minScale;
                cropState.offsetX = 0;
                cropState.offsetY = 0; // NEW
                document.getElementById('zoom-range').value = 100;
                document.getElementById('zoom-label').textContent = '100%';
                updateCropTransform();
            };
            cropState.imgEl.src = cropState.url;

            // Setup drag handlers (horizontal only)
            const onDown = (clientX, clientY) => {
                cropState.dragging = true;
                cropState.dragStartX = clientX;
                cropState.dragStartY = clientY; // NEW
                cropState.startOffsetX = cropState.offsetX;
                cropState.startOffsetY = cropState.offsetY; // NEW
            };
            const onMove = (clientX, clientY) => {
                if(!cropState.dragging) return;
                const dx = clientX - cropState.dragStartX;
                const dy = clientY - cropState.dragStartY; // NEW
                cropState.offsetX = cropState.startOffsetX + dx;
                cropState.offsetY = cropState.startOffsetY + dy; // NEW
                updateCropTransform();
            };
            const onUp = () => { cropState.dragging = false; };

            cropState.frameEl.onmousedown = (e)=> onDown(e.clientX, e.clientY);
            window.onmousemove = (e)=> onMove(e.clientX, e.clientY);
            window.onmouseup = onUp;

            cropState.frameEl.ontouchstart = (e)=>{ if(e.touches[0]) onDown(e.touches[0].clientX, e.touches[0].clientY); };
            window.ontouchmove = (e)=>{ if(e.touches[0]) onMove(e.touches[0].clientX, e.touches[0].clientY); };
            window.ontouchend = onUp;

            // Zoom handler
            const zoom = document.getElementById('zoom-range');
            zoom.oninput = (e)=>{
                const factor = Number(e.target.value) / 100; // 1.0 .. 3.0
                cropState.scale = cropState.minScale * factor; // up to 3x of min
                document.getElementById('zoom-label').textContent = Math.round(factor*100) + '%';
                updateCropTransform();
            };

            // Mouse wheel zoom support
            cropState.frameEl.onwheel = (e) => {
                e.preventDefault();
                const zoomInput = document.getElementById('zoom-range');
                const min = Number(zoomInput.min) || 100;
                const max = Number(zoomInput.max) || 300;
                const step = e.ctrlKey ? 10 : 5; // Ctrl ile daha hÄ±zlÄ± zoom
                let val = Number(zoomInput.value) || 100;
                val += (e.deltaY < 0 ? step : -step); // aÅŸaÄŸÄ±: yakÄ±nlaÅŸ, yukarÄ±: uzaklaÅŸ
                val = Math.max(min, Math.min(max, val));
                zoomInput.value = String(val);

                const factor = val / 100;
                cropState.scale = cropState.minScale * factor;
                document.getElementById('zoom-label').textContent = Math.round(factor*100) + '%';
                updateCropTransform();
            };

            // Buttons
            document.getElementById('cancel-crop-btn').onclick = closeCropModal;
            document.getElementById('save-crop-btn').onclick = saveCroppedProfilePicture;
            document.getElementById('reselect-btn').onclick = () => {
                const input = document.getElementById('profile-picture-input');
                input.value = '';
                input.click();
            };

            overlay.classList.add('open');
        }

        function closeCropModal(){
            const overlay = document.getElementById('cropper-overlay');
            overlay.classList.remove('open');
            // cleanup listeners
            window.onmousemove = null; window.onmouseup = null;
            window.ontouchmove = null; window.ontouchend = null;
            if (cropState.frameEl) { cropState.frameEl.onwheel = null; }
            // release object url
            if(cropState.url){ URL.revokeObjectURL(cropState.url); cropState.url = null; }
        }

        function updateCropTransform(){
            const W = cropState.naturalW * cropState.scale;
            const H = cropState.naturalH * cropState.scale;
            const maxOffsetX = Math.max(0, (W - cropState.d)/2);
            const maxOffsetY = Math.max(0, (H - cropState.d)/2); // NEW
            // clamp shifts so circle alanÄ± her zaman kaplansÄ±n
            cropState.offsetX = Math.min(maxOffsetX, Math.max(-maxOffsetX, cropState.offsetX));
            cropState.offsetY = Math.min(maxOffsetY, Math.max(-maxOffsetY, cropState.offsetY)); // NEW
            // apply transform
            const img = cropState.imgEl;
            img.style.transform = `translate(-50%, -50%) scale(${cropState.scale}) translate(${(cropState.offsetX / cropState.scale)}px, ${(cropState.offsetY / cropState.scale)}px)`;
        }

        async function saveCroppedProfilePicture(){
            // Render current view (circle bounding square) to a canvas and upload
            const d = cropState.d;
            const canvas = document.createElement('canvas');
            canvas.width = d; canvas.height = d;
            const ctx = canvas.getContext('2d');

            const W = cropState.naturalW * cropState.scale;
            const H = cropState.naturalH * cropState.scale;
            const x = (d/2 - W/2) + cropState.offsetX; // horizontal offset in displayed px
            const y = (d/2 - H/2); // vertically centered

            // Fill background white for JPEG
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,d,d);
            ctx.drawImage(cropState.imgEl, x, y, W, H);

            const saveBtn = document.getElementById('save-crop-btn');
            saveBtn.disabled = true; saveBtn.textContent = 'YÃ¼kleniyor...';

            canvas.toBlob(async (blob)=>{
                try {
                    if(!blob){ throw new Error('Blob oluÅŸturulamadÄ±'); }
                    await uploadCroppedImage(blob);
                    closeCropModal();
                } catch(err){
                    console.error(err);
                    showAlert('Profil resmi yÃ¼klenirken bir hata oluÅŸtu', 'error');
                } finally {
                    saveBtn.disabled = false; saveBtn.textContent = 'Kaydet';
                }
            }, 'image/jpeg', 0.92);
        }

        async function uploadCroppedImage(imageBlob){
            const formData = new FormData();
            formData.append('profile_picture', imageBlob, 'profile.jpg');
            try {
                showAlert('Profil resmi yÃ¼kleniyor...', 'success');
                const response = await fetch('/api/users/me/', {
                    method: 'PATCH',
                    headers: { 'Authorization': `Token ${userToken}` },
                    body: formData
                });
                if (response.ok) {
                    const updatedUser = await response.json();
                    originalUserData = { ...updatedUser };
                    const avatarDiv = document.getElementById('avatar');
                    if (updatedUser.profile_picture) {
                        avatarDiv.innerHTML = `
                            <img src="${updatedUser.profile_picture}" alt="Profile Picture">
                        `;
                    }
                    showAlert('Profil resmi baÅŸarÄ±yla gÃ¼ncellendi! âœ“', 'success');
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Profil resmi yÃ¼klenirken bir hata oluÅŸtu', 'error');
                }
            } catch (error) {
                console.error('Failed to upload profile picture:', error);
                showAlert('Profil resmi yÃ¼klenirken bir hata oluÅŸtu', 'error');
            }
        }

        // Replace file input handler to open cropper instead of direct upload
        async function uploadProfilePicture(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showAlert('LÃ¼tfen bir resim dosyasÄ± seÃ§in', 'error');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                showAlert('Dosya boyutu en fazla 5MB olabilir', 'error');
                return;
            }
            openCropModal(file);
        }

        // Sadece butonun tÄ±klama davranÄ±ÅŸÄ±nÄ± baÄŸla (buton dÄ±ÅŸarÄ±da sabit)
        function ensureCameraButton(){
            const btn = document.getElementById('avatar-camera-btn');
            if(!btn) return;
            btn.onclick = () => document.getElementById('profile-picture-input').click();
        }

        document.addEventListener('DOMContentLoaded', () => {
            ensureCameraButton();
            loadUserInfo();
        });
    </script>
</body>
</html>
